<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>圣道云抽奖后台管理</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <style>
        /* 样式保持不变 */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Roboto', 'Noto Sans SC', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #1a237e 0%, #283593 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            color: #333;
        }
        
        .admin-container {
            width: 100%;
            max-width: 1200px;
            background: white;
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .admin-header {
            background: linear-gradient(135deg, #1a73e8 0%, #0d47a1 100%);
            color: white;
            padding: 25px 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .admin-header h1 {
            font-size: 1.8rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .admin-header .logo {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .admin-main {
            display: flex;
            min-height: 600px;
        }
        
        .admin-sidebar {
            width: 250px;
            background: #f5f7fa;
            border-right: 1px solid #e0e0e0;
            padding: 30px 0;
        }
        
        .admin-content {
            flex: 1;
            padding: 30px;
            background: #fafafa;
        }
        
        .nav-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px 30px;
            color: #5f6368;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 1.1rem;
            font-weight: 500;
        }
        
        .nav-item:hover {
            background: #e8f0fe;
            color: #1a73e8;
        }
        
        .nav-item.active {
            background: #e8f0fe;
            color: #1a73e8;
            border-left: 4px solid #1a73e8;
        }
        
        .section-title {
            font-size: 1.6rem;
            color: #1a73e8;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e8eaed;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08), 0 2px 4px rgba(0,0,0,0.05);
            padding: 30px;
            margin-bottom: 30px;
        }
        
        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #1a73e8 0%, #0d47a1 100%);
            border-radius: 12px;
            padding: 25px;
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            box-shadow: 0 6px 15px rgba(26, 115, 232, 0.3);
        }
        
        .stat-card .number {
            font-size: 3.5rem;
            font-weight: bold;
            margin: 15px 0;
        }
        
        .stat-card .label {
            font-size: 1.1rem;
            opacity: 0.9;
        }
        
        .stat-card .icon {
            font-size: 2.5rem;
            background: rgba(255,255,255,0.2);
            width: 70px;
            height: 70px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .card-actions {
            display: flex;
            gap: 15px;
            margin-bottom: 25px;
        }
        
        .btn {
            background: #1a73e8;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px 25px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.2s;
        }
        
        .btn:hover {
            background: #1669d6;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .btn-danger {
            background: #e53935;
        }
        
        .btn-danger:hover {
            background: #c62828;
        }
        
        .btn-success {
            background: #43a047;
        }
        
        .btn-success:hover {
            background: #388e3c;
        }
        
        .table-container {
            overflow-x: auto;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }
        
        th {
            background: #f5f7fa;
            padding: 16px 20px;
            text-align: left;
            font-weight: 500;
            color: #1a73e8;
            border-bottom: 2px solid #e0e0e0;
        }
        
        td {
            padding: 14px 20px;
            border-bottom: 1px solid #e0e0e0;
        }
        
        tr:hover {
            background-color: #f9f9f9;
        }
        
        .action-cell {
            display: flex;
            gap: 10px;
        }
        
        .login-container {
            width: 100%;
            max-width: 450px;
            background: white;
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            padding: 40px;
        }
        
        .login-title {
            text-align: center;
            margin-bottom: 30px;
            color: #1a73e8;
            font-size: 1.8rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }
        
        .input-group {
            margin-bottom: 25px;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #5f6368;
        }
        
        .input-group input {
            width: 100%;
            padding: 14px 18px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.2s;
        }
        
        .input-group input:focus {
            border-color: #1a73e8;
            outline: none;
            box-shadow: 0 0 0 3px rgba(26, 115, 232, 0.2);
        }
        
        .login-btn {
            width: 100%;
            background: #1a73e8;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 16px;
            font-size: 1.1rem;
            font-weight: 500;
            cursor: pointer;
            margin-top: 10px;
            transition: all 0.2s;
        }
        
        .login-btn:hover {
            background: #1669d6;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(26, 115, 232, 0.3);
        }
        
        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 25px;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .alert-danger {
            background: #ffebee;
            color: #c62828;
            border-left: 4px solid #c62828;
        }
        
        .alert-success {
            background: #e8f5e9;
            color: #2e7d32;
            border-left: 4px solid #2e7d32;
        }
        
        .form-row {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .form-group {
            flex: 1;
        }
        
        .card-key {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            font-family: monospace;
            font-size: 1.2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .card-key-list {
            max-height: 400px;
            overflow-y: auto;
            margin-top: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
        }
        
        .chart-container {
            height: 350px;
            margin-top: 30px;
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }
        
        .logout-btn {
            background: rgba(255,255,255,0.15);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 24px;
            padding: 8px 20px;
            font-size: 1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
        }
        
        .logout-btn:hover {
            background: rgba(255,255,255,0.25);
        }
        
        .login-icon {
            font-size: 3rem;
            color: #1a73e8;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .login-subtitle {
            text-align: center;
            color: #5f6368;
            margin-bottom: 30px;
            font-size: 1.1rem;
        }
        
        .prize-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-top: 20px;
        }
        
        .prize-form-row {
            display: flex;
            gap: 20px;
        }
        
        .prize-form-group {
            flex: 1;
        }
        
        .settings-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        @media (max-width: 768px) {
            .admin-main {
                flex-direction: column;
            }
            
            .admin-sidebar {
                width: 100%;
                border-right: none;
                border-bottom: 1px solid #e0e0e0;
            }
            
            .stats-container {
                grid-template-columns: 1fr;
            }
            
            .form-row, .prize-form-row {
                flex-direction: column;
                gap: 15px;
            }
        }
    </style>
</head>
<body>
    <div id="loginPage" class="login-container">
        <div class="login-icon">
            <i class="material-icons">admin_panel_settings</i>
        </div>
        <h1 class="login-title">圣道云抽奖后台管理</h1>
        <p class="login-subtitle">请输入管理员密码进入系统</p>
        
        <div class="input-group">
            <label for="password">管理员密码</label>
            <input type="password" id="password" placeholder="请输入管理密码">
        </div>
        
        <button class="login-btn" id="loginBtn">
            <i class="material-icons">lock_open</i>
            <span>登录系统</span>
        </button>
        
        <div id="loginAlert" class="alert" style="display: none;"></div>
    </div>
    
    <div id="adminPage" class="admin-container" style="display: none;">
        <div class="admin-header">
            <div class="logo">
                <i class="material-icons">cloud</i>
                <h1 id="adminTitle">圣道云抽奖后台管理系统</h1>
            </div>
            <button class="logout-btn" id="logoutBtn">
                <i class="material-icons">exit_to_app</i>
                <span>退出登录</span>
            </button>
        </div>
        
        <div class="admin-main">
            <div class="admin-sidebar">
                <div class="nav-item active" data-section="dashboard">
                    <i class="material-icons">dashboard</i>
                    <span>数据概览</span>
                </div>
                <div class="nav-item" data-section="cardManagement">
                    <i class="material-icons">vpn_key</i>
                    <span>卡密管理</span>
                </div>
                <div class="nav-item" data-section="prizeManagement">
                    <i class="material-icons">card_giftcard</i>
                    <span>奖品管理</span>
                </div>
                <div class="nav-item" data-section="userManagement">
                    <i class="material-icons">people</i>
                    <span>用户管理</span>
                </div>
                <div class="nav-item" data-section="settings">
                    <i class="material-icons">settings</i>
                    <span>系统设置</span>
                </div>
            </div>
            
            <div class="admin-content">
                <!-- 数据概览 -->
                <div id="dashboard" class="content-section">
                    <h2 class="section-title">
                        <i class="material-icons">dashboard</i>
                        <span>数据概览</span>
                    </h2>
                    
                    <div class="stats-container">
                        <div class="stat-card">
                            <div class="icon">
                                <i class="material-icons">people</i>
                            </div>
                            <div class="number" id="totalUsers">0</div>
                            <div class="label">总参与人数</div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="icon">
                                <i class="material-icons">autorenew</i>
                            </div>
                            <div class="number" id="totalDraws">0</div>
                            <div class="label">总抽奖次数</div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="icon">
                                <i class="material-icons">card_giftcard</i>
                            </div>
                            <div class="number" id="totalPrizes">0</div>
                            <div class="label">总中奖次数</div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <h3 class="section-title" style="font-size: 1.4rem;">
                            <i class="material-icons">bar_chart</i>
                            <span>抽奖数据统计</span>
                        </h3>
                        
                        <div class="chart-container">
                            <canvas id="statsChart"></canvas>
                        </div>
                    </div>
                    
                    <div class="card">
                        <h3 class="section-title" style="font-size: 1.4rem;">
                            <i class="material-icons">list</i>
                            <span>最近中奖记录</span>
                        </h3>
                        
                        <div class="table-container">
                            <table id="recentWinsTable">
                                <thead>
                                    <tr>
                                        <th>用户ID</th>
                                        <th>奖品名称</th>
                                        <th>中奖时间</th>
                                        <th>IP地址</th>
                                        <th>状态</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- 动态加载 -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- 卡密管理 -->
                <div id="cardManagement" class="content-section" style="display: none;">
                    <h2 class="section-title">
                        <i class="material-icons">vpn_key</i>
                        <span>卡密管理</span>
                    </h2>
                    
                    <div class="card">
                        <h3 class="section-title" style="font-size: 1.4rem;">
                            <i class="material-icons">add</i>
                            <span>生成卡密</span>
                        </h3>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="cardType">卡密类型</label>
                                <select id="cardType" class="input-group input">
                                    <option value="VIP">VIP卡</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label for="cardCount">生成数量</label>
                                <input type="number" id="cardCount" class="input-group input" value="5" min="1" max="100">
                            </div>
                            
                            <div class="form-group">
                                <label for="cardValue">有效天数</label>
                                <input type="number" id="cardValue" class="input-group input" value="30" min="1">
                            </div>
                        </div>
                        
                        <div class="card-actions">
                            <button class="btn" id="generateCards">
                                <i class="material-icons">add_circle</i>
                                <span>生成卡密</span>
                            </button>
                        </div>
                        
                        <div id="generatedCards" class="card-key-list"></div>
                    </div>
                    
                    <div class="card">
                        <h3 class="section-title" style="font-size: 1.4rem;">
                            <i class="material-icons">list</i>
                            <span>卡密列表</span>
                        </h3>
                        
                        <div class="card-actions">
                            <button class="btn btn-danger" id="deleteUsedCards">
                                <i class="material-icons">delete</i>
                                <span>删除已使用卡密</span>
                            </button>
                            
                            <button class="btn" id="exportCards">
                                <i class="material-icons">file_download</i>
                                <span>导出卡密</span>
                            </button>
                        </div>
                        
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>卡密</th>
                                        <th>类型</th>
                                        <th>有效期</th>
                                        <th>状态</th>
                                        <th>生成时间</th>
                                        <th>操作</th>
                                    </tr>
                                </thead>
                                <tbody id="cardList">
                                    <!-- 动态加载 -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- 奖品管理 -->
                <div id="prizeManagement" class="content-section" style="display: none;">
                    <h2 class="section-title">
                        <i class="material-icons">card_giftcard</i>
                        <span>奖品管理</span>
                    </h2>
                    
                    <div class="card">
                        <div class="card-actions">
                            <button class="btn" id="addPrizeBtn">
                                <i class="material-icons">add</i>
                                <span>添加奖品</span>
                            </button>
                        </div>
                        
                        <div class="prize-form" id="prizeForm" style="display: none;">
                            <div class="prize-form-row">
                                <div class="prize-form-group">
                                    <label for="prizeName">奖品名称</label>
                                    <input type="text" id="prizeName" class="input-group input">
                                </div>
                                <div class="prize-form-group">
                                    <label for="prizeIcon">图标代码</label>
                                    <input type="text" id="prizeIcon" class="input-group input" placeholder="material-icons代码">
                                </div>
                            </div>
                            
                            <div class="prize-form-row">
                                <div class="prize-form-group">
                                    <label for="prizeProbability">概率 (%)</label>
                                    <input type="number" id="prizeProbability" class="input-group input" min="0" max="100" step="0.1">
                                </div>
                                <div class="prize-form-group">
                                    <label for="prizeDesc">奖品描述</label>
                                    <input type="text" id="prizeDesc" class="input-group input">
                                </div>
                            </div>
                            
                            <div class="card-actions">
                                <button class="btn" id="savePrize">
                                    <i class="material-icons">save</i>
                                    <span>保存奖品</span>
                                </button>
                                <button class="btn btn-danger" id="cancelPrize">
                                    <i class="material-icons">cancel</i>
                                    <span>取消</span>
                                </button>
                            </div>
                        </div>
                        
                        <div class="table-container" style="margin-top: 20px;">
                            <table id="prizesTable">
                                <thead>
                                    <tr>
                                        <th>奖品名称</th>
                                        <th>描述</th>
                                        <th>图标</th>
                                        <th>概率(%)</th>
                                        <th>操作</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- 动态加载 -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- 用户管理 -->
                <div id="userManagement" class="content-section" style="display: none;">
                    <h2 class="section-title">
                        <i class="material-icons">people</i>
                        <span>用户管理</span>
                    </h2>
                    
                    <div class="card">
                        <div class="table-container">
                            <table id="usersTable">
                                <thead>
                                    <tr>
                                        <th>IP地址</th>
                                        <th>设备信息</th>
                                        <th>访问时间</th>
                                        <th>操作</th>
                                        <th>详情</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- 动态加载 -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- 系统设置 -->
                <div id="settings" class="content-section" style="display: none;">
                    <h2 class="section-title">
                        <i class="material-icons">settings</i>
                        <span>系统设置</span>
                    </h2>
                    
                    <div class="card">
                        <div class="settings-form">
                            <div class="input-group">
                                <label for="siteName">网站名称</label>
                                <input type="text" id="siteName" placeholder="网站名称">
                            </div>
                            
                            <div class="input-group">
                                <label for="dailyLimit">每日抽奖次数</label>
                                <input type="number" id="dailyLimit" min="1" max="20">
                            </div>
                            
                            <div class="input-group">
                                <label for="vipDailyLimit">VIP每日抽奖次数</label>
                                <input type="number" id="vipDailyLimit" min="1" max="20">
                            </div>
                            
                            <button class="btn" id="saveSettings">
                                <i class="material-icons">save</i>
                                <span>保存设置</span>
                            </button>
                        </div>
                        
                        <h3 style="margin: 30px 0 15px; color: #1a73e8; padding-top: 20px; border-top: 1px solid #eee;">管理员登录日志</h3>
                        
                        <div class="table-container">
                            <table id="loginLogsTable">
                                <thead>
                                    <tr>
                                        <th>登录时间</th>
                                        <th>IP地址</th>
                                        <th>设备信息</th>
                                        <th>状态</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- 动态加载 -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 引入Chart.js用于图表 -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script>
        // 数据键名
        const DATA_KEYS = {
            CARDS: 'sdy_cards',
            PRIZES: 'sdy_prizes',
            USERS: 'sdy_users',
            SETTINGS: 'sdy_settings',
            LOGS: 'sdy_logs',
            ACTIONS: 'sdy_actions',
            USED_CARDS: 'usedCardKeys'
        };
        
        // 全局变量
        let currentPrizeIndex = -1;
        let chartInstance = null;

        document.addEventListener('DOMContentLoaded', function() {
            // 页面元素
            const loginPage = document.getElementById('loginPage');
            const adminPage = document.getElementById('adminPage');
            const passwordInput = document.getElementById('password');
            const loginBtn = document.getElementById('loginBtn');
            const loginAlert = document.getElementById('loginAlert');
            const logoutBtn = document.getElementById('logoutBtn');
            const navItems = document.querySelectorAll('.nav-item');
            const contentSections = document.querySelectorAll('.content-section');
            const adminTitle = document.getElementById('adminTitle');
            
            // 设置管理密码
            const ADMIN_PASSWORD = "adminyy123";
            
            // 检查是否已登录
            function checkLogin() {
                const isLoggedIn = localStorage.getItem('adminLoggedIn') === 'true';
                if (isLoggedIn) {
                    loginPage.style.display = 'none';
                    adminPage.style.display = 'block';
                    
                    // 记录登录日志
                    recordLoginLog(true);
                    
                    // 初始化各个模块
                    initDashboard();
                    initCardManagement();
                    initPrizeManagement();
                    initUserManagement();
                    initSettings();
                }
            }
            
            // 记录登录日志
            function recordLoginLog(success) {
                const logs = JSON.parse(localStorage.getItem(DATA_KEYS.LOGS)) || [];
                const logEntry = {
                    time: new Date().toISOString(),
                    ip: '192.168.1.1', // 实际应用中应获取真实IP
                    device: navigator.userAgent,
                    status: success ? '成功' : '失败'
                };
                logs.push(logEntry);
                localStorage.setItem(DATA_KEYS.LOGS, JSON.stringify(logs));
            }
            
            // 初始化仪表盘
            function initDashboard() {
                // 获取真实数据
                const actions = JSON.parse(localStorage.getItem(DATA_KEYS.ACTIONS)) || [];
                const prizes = JSON.parse(localStorage.getItem(DATA_KEYS.PRIZES)) || [];
                
                // 计算总抽奖次数
                let totalDraws = 0;
                actions.forEach(action => {
                    if (action.action === '抽奖') {
                        totalDraws++;
                    }
                });
                
                // 计算总中奖次数
                let totalWins = 0;
                actions.forEach(action => {
                    if (action.action === '抽奖' && !action.details.includes('谢谢参与')) {
                        totalWins++;
                    }
                });
                
                // 更新数据概览
                document.getElementById('totalUsers').textContent = actions.length.toLocaleString();
                document.getElementById('totalDraws').textContent = totalDraws.toLocaleString();
                document.getElementById('totalPrizes').textContent = totalWins.toLocaleString();
                
                // 初始化图表
                const ctx = document.getElementById('statsChart').getContext('2d');
                
                // 销毁之前的图表实例
                if (chartInstance) {
                    chartInstance.destroy();
                }
                
                // 生成最近7天的日期
                const dates = [];
                for (let i = 6; i >= 0; i--) {
                    const date = new Date();
                    date.setDate(date.getDate() - i);
                    dates.push(date.toLocaleDateString());
                }
                
                // 生成抽奖数据
                const drawData = dates.map(date => {
                    return actions.filter(action => {
                        const actionDate = new Date(action.timestamp).toLocaleDateString();
                        return actionDate === date && action.action === '抽奖';
                    }).length;
                });
                
                // 生成中奖数据
                const winData = dates.map(date => {
                    return actions.filter(action => {
                        const actionDate = new Date(action.timestamp).toLocaleDateString();
                        return actionDate === date && action.action === '抽奖' && !action.details.includes('谢谢参与');
                    }).length;
                });
                
                chartInstance = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: dates,
                        datasets: [{
                            label: '抽奖次数',
                            data: drawData,
                            backgroundColor: 'rgba(26, 115, 232, 0.7)',
                            borderColor: 'rgba(26, 115, 232, 1)',
                            borderWidth: 1
                        }, {
                            label: '中奖次数',
                            data: winData,
                            backgroundColor: 'rgba(76, 175, 80, 0.7)',
                            borderColor: 'rgba(76, 175, 80, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                grid: {
                                    color: 'rgba(0,0,0,0.05)'
                                }
                            },
                            x: {
                                grid: {
                                    display: false
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                position: 'top',
                            },
                            title: {
                                display: true,
                                text: '最近7天抽奖数据统计'
                            }
                        }
                    }
                });
                
                // 加载最近中奖记录
                loadRecentWins();
            }
            
            // 加载最近中奖记录
            function loadRecentWins() {
                const actions = JSON.parse(localStorage.getItem(DATA_KEYS.ACTIONS)) || [];
                const wins = actions.filter(a => a.action === '抽奖' && !a.details.includes('谢谢参与'))
                                  .slice(-5)
                                  .reverse();
                
                const tbody = document.querySelector('#recentWinsTable tbody');
                tbody.innerHTML = '';
                
                wins.forEach(win => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${win.ip}</td>
                        <td>${win.details.split(':')[1] || win.details}</td>
                        <td>${new Date(win.timestamp).toLocaleString()}</td>
                        <td>${win.ip}</td>
                        <td><span style="color: #4caf50;">已发放</span></td>
                    `;
                    tbody.appendChild(tr);
                });
            }
            
            // 初始化卡密管理
            function initCardManagement() {
                loadCardList();
                
                // 生成卡密
                document.getElementById('generateCards').addEventListener('click', function() {
                    const type = document.getElementById('cardType').value;
                    const count = parseInt(document.getElementById('cardCount').value) || 5;
                    const value = document.getElementById('cardValue').value;
                    
                    if (count > 100) {
                        alert('一次最多生成100个卡密');
                        return;
                    }
                    
                    let cardsHTML = '';
                    const cards = JSON.parse(localStorage.getItem(DATA_KEYS.CARDS)) || [];
                    
                    for (let i = 0; i < count; i++) {
                        const card = generateCard(type, value);
                        cards.push(card);
                        
                        cardsHTML += `
                        <div class="card-key">
                            <div>${card.key}</div>
                            <div>
                                <span style="margin-right: 15px;">${type}卡 (${value}天)</span>
                                <button class="btn" onclick="copyToClipboard('${card.key}')">
                                    <i class="material-icons">content_copy</i>
                                </button>
                            </div>
                        </div>
                        `;
                    }
                    
                    localStorage.setItem(DATA_KEYS.CARDS, JSON.stringify(cards));
                    document.getElementById('generatedCards').innerHTML = cardsHTML;
                    
                    // 重新加载卡密列表
                    loadCardList();
                });
                
                // 删除已使用卡密
                document.getElementById('deleteUsedCards').addEventListener('click', function() {
                    const cards = JSON.parse(localStorage.getItem(DATA_KEYS.CARDS)) || [];
                    const usedCards = JSON.parse(localStorage.getItem(DATA_KEYS.USED_CARDS)) || [];
                    
                    // 过滤出未使用的卡密
                    const activeCards = cards.filter(card => !usedCards.includes(card.key));
                    
                    localStorage.setItem(DATA_KEYS.CARDS, JSON.stringify(activeCards));
                    loadCardList();
                    alert('已删除所有已使用的卡密');
                });
                
                // 导出卡密
                document.getElementById('exportCards').addEventListener('click', function() {
                    const cards = JSON.parse(localStorage.getItem(DATA_KEYS.CARDS)) || [];
                    if (cards.length === 0) {
                        alert('没有卡密可导出');
                        return;
                    }
                    
                    let csvContent = "卡密,类型,有效期,状态,生成时间\n";
                    cards.forEach(card => {
                        const isUsed = JSON.parse(localStorage.getItem(DATA_KEYS.USED_CARDS)) || [];
                        const status = isUsed.includes(card.key) ? '已使用' : '未使用';
                        csvContent += `${card.key},${card.type},${card.value}天,${status},${new Date(card.created).toLocaleString()}\n`;
                    });
                    
                    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement("a");
                    link.setAttribute("href", url);
                    link.setAttribute("download", "卡密列表.csv");
                    link.style.visibility = 'hidden';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                });
            }
            
            // 加载卡密列表
            function loadCardList() {
                const cards = JSON.parse(localStorage.getItem(DATA_KEYS.CARDS)) || [];
                const usedCards = JSON.parse(localStorage.getItem(DATA_KEYS.USED_CARDS)) || [];
                const tbody = document.querySelector('#cardList');
                tbody.innerHTML = '';
                
                cards.forEach(card => {
                    const isUsed = usedCards.includes(card.key);
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${card.key}</td>
                        <td>${card.type}卡</td>
                        <td>${card.value}天</td>
                        <td><span style="color: ${isUsed ? '#f44336' : '#4caf50'};">${isUsed ? '已使用' : '未使用'}</span></td>
                        <td>${new Date(card.created).toLocaleDateString()}</td>
                        <td class="action-cell">
                            <button class="btn btn-danger" onclick="deleteCard('${card.key}')">
                                <i class="material-icons">delete</i>
                            </button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            }
            
            // 初始化奖品管理
            function initPrizeManagement() {
                loadPrizes();
                
                // 添加奖品按钮
                document.getElementById('addPrizeBtn').addEventListener('click', function() {
                    document.getElementById('prizeForm').style.display = 'block';
                    currentPrizeIndex = -1;
                    
                    // 清空表单
                    document.getElementById('prizeName').value = '';
                    document.getElementById('prizeIcon').value = 'card_giftcard';
                    document.getElementById('prizeProbability').value = '';
                    document.getElementById('prizeDesc').value = '';
                });
                
                // 保存奖品
                document.getElementById('savePrize').addEventListener('click', function() {
                    const name = document.getElementById('prizeName').value.trim();
                    const icon = document.getElementById('prizeIcon').value.trim();
                    const probability = parseFloat(document.getElementById('prizeProbability').value);
                    const desc = document.getElementById('prizeDesc').value.trim();
                    
                    if (!name || !icon || isNaN(probability) || !desc) {
                        alert('请填写所有字段');
                        return;
                    }
                    
                    const prizes = JSON.parse(localStorage.getItem(DATA_KEYS.PRIZES)) || [];
                    
                    if (currentPrizeIndex === -1) {
                        // 添加新奖品
                        prizes.push({
                            name,
                            icon,
                            probability,
                            desc
                        });
                    } else {
                        // 更新现有奖品
                        prizes[currentPrizeIndex] = {
                            name,
                            icon,
                            probability,
                            desc
                        };
                    }
                    
                    localStorage.setItem(DATA_KEYS.PRIZES, JSON.stringify(prizes));
                    document.getElementById('prizeForm').style.display = 'none';
                    loadPrizes();
                });
                
                // 取消编辑
                document.getElementById('cancelPrize').addEventListener('click', function() {
                    document.getElementById('prizeForm').style.display = 'none';
                });
            }
            
            // 加载奖品列表
            function loadPrizes() {
                const prizes = JSON.parse(localStorage.getItem(DATA_KEYS.PRIZES)) || [];
                const tbody = document.querySelector('#prizesTable tbody');
                tbody.innerHTML = '';
                
                prizes.forEach((prize, index) => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${prize.name}</td>
                        <td>${prize.desc}</td>
                        <td><i class="material-icons">${prize.icon}</i></td>
                        <td>${prize.probability}</td>
                        <td class="action-cell">
                            <button class="btn" onclick="editPrize(${index})">
                                <i class="material-icons">edit</i>
                            </button>
                            <button class="btn btn-danger" onclick="deletePrize(${index})">
                                <i class="material-icons">delete</i>
                            </button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            }
            
            // 初始化用户管理
            function initUserManagement() {
                loadUserActions();
            }
            
            // 加载用户活动
            function loadUserActions() {
                const actions = JSON.parse(localStorage.getItem(DATA_KEYS.ACTIONS)) || [];
                const tbody = document.querySelector('#usersTable tbody');
                tbody.innerHTML = '';
                
                // 按时间倒序排列
                actions.slice().reverse().forEach(action => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${action.ip}</td>
                        <td>${action.device.substring(0, 50)}...</td>
                        <td>${new Date(action.timestamp).toLocaleString()}</td>
                        <td>${action.action}</td>
                        <td>${action.details}</td>
                    `;
                    tbody.appendChild(tr);
                });
            }
            
            // 初始化系统设置
            function initSettings() {
                const settings = JSON.parse(localStorage.getItem(DATA_KEYS.SETTINGS)) || {
                    siteName: '圣道云幸运抽奖',
                    dailyLimit: 3,
                    vipDailyLimit: 6
                };
                
                // 应用设置
                document.getElementById('siteName').value = settings.siteName;
                document.getElementById('dailyLimit').value = settings.dailyLimit;
                document.getElementById('vipDailyLimit').value = settings.vipDailyLimit;
                adminTitle.textContent = `${settings.siteName}后台管理系统`;
                
                // 加载登录日志
                const logs = JSON.parse(localStorage.getItem(DATA_KEYS.LOGS)) || [];
                const tbody = document.querySelector('#loginLogsTable tbody');
                tbody.innerHTML = '';
                
                logs.reverse().forEach(log => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${new Date(log.time).toLocaleString()}</td>
                        <td>${log.ip}</td>
                        <td>${log.device.substring(0, 50)}...</td>
                        <td><span style="color: ${log.status === '成功' ? '#4caf50' : '#f44336'};">${log.status}</span></td>
                    `;
                    tbody.appendChild(tr);
                });
                
                // 保存设置
                document.getElementById('saveSettings').addEventListener('click', function() {
                    const siteName = document.getElementById('siteName').value;
                    const dailyLimit = parseInt(document.getElementById('dailyLimit').value) || 3;
                    const vipDailyLimit = parseInt(document.getElementById('vipDailyLimit').value) || 6;
                    
                    const settings = {
                        siteName,
                        dailyLimit,
                        vipDailyLimit
                    };
                    
                    localStorage.setItem(DATA_KEYS.SETTINGS, JSON.stringify(settings));
                    adminTitle.textContent = `${siteName}后台管理系统`;
                    alert('设置已保存');
                });
            }
            
            // 登录功能
            loginBtn.addEventListener('click', function() {
                const password = passwordInput.value.trim();
                
                if (password === '') {
                    showLoginAlert('请输入管理员密码', 'danger');
                    return;
                }
                
                if (password === ADMIN_PASSWORD) {
                    // 登录成功
                    localStorage.setItem('adminLoggedIn', 'true');
                    loginPage.style.display = 'none';
                    adminPage.style.display = 'block';
                    
                    // 记录登录日志
                    recordLoginLog(true);
                    
                    // 初始化各个模块
                    initDashboard();
                    initCardManagement();
                    initPrizeManagement();
                    initUserManagement();
                    initSettings();
                } else {
                    showLoginAlert('管理员密码错误，请重新输入', 'danger');
                    recordLoginLog(false);
                }
            });
            
            // 退出登录
            logoutBtn.addEventListener('click', function() {
                localStorage.removeItem('adminLoggedIn');
                adminPage.style.display = 'none';
                loginPage.style.display = 'block';
                passwordInput.value = '';
            });
            
            // 导航切换
            navItems.forEach(item => {
                item.addEventListener('click', function() {
                    const section = this.getAttribute('data-section');
                    
                    // 更新导航激活状态
                    navItems.forEach(nav => nav.classList.remove('active'));
                    this.classList.add('active');
                    
                    // 显示对应内容区域
                    contentSections.forEach(sec => sec.style.display = 'none');
                    document.getElementById(section).style.display = 'block';
                    
                    // 初始化对应模块
                    if (section === 'dashboard') {
                        initDashboard();
                    } else if (section === 'cardManagement') {
                        initCardManagement();
                    } else if (section === 'prizeManagement') {
                        initPrizeManagement();
                    } else if (section === 'userManagement') {
                        initUserManagement();
                    } else if (section === 'settings') {
                        initSettings();
                    }
                });
            });
            
            // 显示登录提示
            function showLoginAlert(message, type) {
                loginAlert.textContent = message;
                loginAlert.className = `alert alert-${type}`;
                loginAlert.style.display = 'flex';
                
                setTimeout(() => {
                    loginAlert.style.display = 'none';
                }, 3000);
            }
            
            // 页面加载时检查登录状态
            checkLogin();
        });
        
        // 生成随机卡密
        function generateCard(type, value) {
            const prefix = type === 'VIP' ? 'VIP' : 'PRIZE';
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let key = prefix + '-';
            
            for (let i = 0; i < 3; i++) {
                for (let j = 0; j < 4; j++) {
                    key += chars.charAt(Math.floor(Math.random() * chars.length));
                }
                if (i < 2) key += '-';
            }
            
            return {
                key,
                type,
                value,
                created: new Date().toISOString()
            };
        }
        
        // 复制到剪贴板
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                alert('卡密已复制到剪贴板: ' + text);
            });
        }
        
        // 删除卡密
        function deleteCard(key) {
            const cards = JSON.parse(localStorage.getItem('sdy_cards')) || [];
            const newCards = cards.filter(card => card.key !== key);
            localStorage.setItem('sdy_cards', JSON.stringify(newCards));
            loadCardList();
        }
        
        // 编辑奖品
        function editPrize(index) {
            const prizes = JSON.parse(localStorage.getItem('sdy_prizes')) || [];
            const prize = prizes[index];
            
            document.getElementById('prizeName').value = prize.name;
            document.getElementById('prizeIcon').value = prize.icon;
            document.getElementById('prizeProbability').value = prize.probability;
            document.getElementById('prizeDesc').value = prize.desc;
            
            document.getElementById('prizeForm').style.display = 'block';
            currentPrizeIndex = index;
        }
        
        // 删除奖品
        function deletePrize(index) {
            const prizes = JSON.parse(localStorage.getItem('sdy_prizes')) || [];
            prizes.splice(index, 1);
            localStorage.setItem('sdy_prizes', JSON.stringify(prizes));
            loadPrizes();
        }
    </script>
</body>
</html>
